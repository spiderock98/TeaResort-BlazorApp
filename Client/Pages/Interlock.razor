@page "/interlock"
@inject NavigationManager uriHelper
@using BlazorDateRangePicker
@using Helper
@inject IJSRuntime JSHelper
@using SmartRetail.Shared
@using SmartRetail.Client.Services
@using Share.Models
@using System.Collections
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager NavHelper
@using System
@using Newtonsoft.Json
@inject ISnackbar Snackbar
@using System.Timers


<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col text-center">
                    <h1 style="font-size:50px;">Interlock Profiles</h1>
                </div>
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </section>
    <!-- /.content-header -->
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">

            <div class="card card-primary">
                <div class="card-body">

                    <MudButton Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.AddCircle"
                               Color="Color.Success"
                               data-toggle="modal"
                               data-target="#mdNewScene"
                               @onclick=@(()=>
                               {
                               NewSceneParams = new GlobalSceneModel();
                               InvokeAsync(StateHasChanged);
                               })>
                        ADD INTERLOCK
                    </MudButton>

                    @*<table class="bootstrap-table"
                    data-search="true"
                    data-show-export="true"
                    data-search-align="right"
                    data-buttons-align="right"
                    data-pagination="true"
                    data-height="700">
                    <thead>
                    <tr class="text-center">
                    <th>No.</th>
                    <th>NAME</th>
                    <th>ENABLE</th>
                    <th>LAST RUN</th>
                    <th>CONTROL</th>
                    </tr>
                    </thead>
                    <tbody>
                    @{
                    foreach (var profile in LstScene.OrderByDescending(r => r.Id))
                    {
                    <tr class="text-center">
                    <th>@profile.Id</th>
                    <td>@profile.Name</td>
                    @{ if (profile.Enable)
                    {
                    <td>
                    <span class="badge badge-pill badge-success">Enable</span>

                    </td>
                    }
                    else
                    {
                    <td>
                    <span class="badge badge-pill badge-danger">Disable</span>
                    </td>
                    }
                    }
                    <td>@UnixTime.UnixMillisToLocalTimeFormat(profile.LastRunTime)</td>
                    <td>
                    <div class="d-flex flex-wrap">
                    <button class="btn btn-xs btn-primary m-1"
                    type="button"
                    data-toggle="modal"
                    data-target="#mdEditScene"
                    @onclick=@(() => { PreEdit(profile); })>
                    <i class="fas fa-edit"></i>
                    </button>

                    @{
                    string attrBtnEnable = profile.Enable ? "light" : "success";
                    var titleTooltip = profile.Enable ? "Disable Schedule" : "Enable Schedule";
                    }
                    <button data-toggle="tooltip"
                    data-placement="top"
                    title="@titleTooltip" class="btn btn-xs btn-@attrBtnEnable m-1"
                    @onclick=@(() => { ChangeScheduleStateHandle(profile); })>
                    <i class="fas fa-power-off"></i>
                    </button>

                    <button data-toggle="tooltip"
                    data-placement="top"
                    title="Clone" class="btn btn-xs btn-info m-1"
                    @onclick=@(() =>
                    {
                    CloneProfileHanlde(profile);
                    })>
                    <i class="far fa-clone"></i>
                    </button>
                    </div>
                    </td>
                    </tr>
                    }
                    }
                    </tbody>
                    </table>*@




                    <MudTable Hover=true
                              @ref="table"
                              Elevation="0"
                              ServerData="@(new Func<TableState, Task<TableData<GlobalSceneModel>>>(ServerReload))">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">List DS1 Interlock</MudText>
                            <MudSpacer />
                            <MudTextField T="string"
                                          ValueChanged="@(s=>OnSearch(s))"
                                          Placeholder="Search"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          IconSize="Size.Medium"
                                          Class="mt-0">

                            </MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh Style="text-align:center;"><MudTableSortLabel InitialDirection="SortDirection.Descending" SortLabel="id_field" T="GlobalSceneModel">No.</MudTableSortLabel></MudTh>
                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="name_field" T="GlobalSceneModel">NAME</MudTableSortLabel></MudTh>
                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="enable_field" T="GlobalSceneModel">ENABLE</MudTableSortLabel></MudTh>
                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="lastrun_field" T="GlobalSceneModel">LAST RUN</MudTableSortLabel></MudTh>
                            <MudTh Style="text-align:center;"></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            <MudTd Style="text-align:center;" DataLabel="No.">@context.Id</MudTd>
                            <MudTd Style="text-align:center;" DataLabel="NAME">@context.Name</MudTd>
                            <MudTd Style="text-align:center;">
                                @if (context.Enable)
                                {
                                    <span class="badge badge-pill badge-success">Enable</span>
                                }
                                else
                                {
                                    <span class="badge badge-pill badge-danger">Disable</span>
                                }
                            </MudTd>
                            <MudTd Style="text-align:center;">
                                @UnixTime.UnixMillisToLocalTimeFormat(context.LastRunTime)
                            </MudTd>

                            <MudTd Style="text-align:center;">
                                <MudButtonGroup Size="Size.Small"
                                                Color="Color.Default"
                                                Variant="Variant.Text">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   data-toggle="modal"
                                                   data-target="#mdEditScene"
                                                   @onclick=@(() => { PreEdit(context); })></MudIconButton>

                                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                                   @onclick=@(() =>
                                                   {
                                                   CloneProfileHanlde(context);
                                                   })>

                                    </MudIconButton>

                                    <MudToggleIconButton Icon="@Icons.Material.Filled.PowerOff"
                                                         Color="@Color.Error"
                                                         Title="Off"
                                                         ToggledIcon="@Icons.Material.Filled.Power"
                                                         ToggledColor="@Color.Success"
                                                         Toggled="!context.Enable"
                                                         ToggledTitle="On"
                                                         ToggledChanged=@(() => { ChangeScheduleStateHandle(context); }) />

                                </MudButtonGroup>
                            </MudTd>
                        </RowTemplate>

                        <NoRecordsContent>
                            <MudText>No matching records found</MudText>
                        </NoRecordsContent>
                        <LoadingContent>
                            <MudText>Loading...</MudText>
                        </LoadingContent>

                        <PagerContent>
                            <MudTablePager />
                        </PagerContent>
                    </MudTable>



                </div>
            </div>

            @if (LstDevice.Select(r => r.Capabilitie).Contains("ViotVRV"))
            {
                <MudPaper Class="pa-4">
                    <MudGrid>
                        <MudItem xs="5">
                            <MudSelect T="string"
                                   @bind-Value="crDS4GwId"
                                   Label="DS4 Gateway"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Variant="Variant.Text"
                                   OffsetY="true"
                                   Margin="Margin.Dense"
                                   Dense="true">
                                @foreach (var it in LstAllDataSource.Where(r => r.SourceType == "SVMDS4"))
                                {
                                    <MudSelectItem Value="@it.ID">
                                        [@it.ID] @it.Name
                                    </MudSelectItem>
                                }

                            </MudSelect>
                        </MudItem>

                        <MudItem xs="5">
                            <MudSelect T="int"
                                   @bind-Value="crDS4InterlockId"
                                   Label="Profile ID"
                                   AnchorOrigin="Origin.BottomCenter"
                                   Variant="Variant.Text"
                                   OffsetY="true"
                                   Margin="Margin.Dense"
                                   Dense="true">
                                @for (int i = 0; i < 49; i++)
                                {
                                    <MudSelectItem Value="@(i)" />
                                }

                            </MudSelect>
                        </MudItem>

                        <MudItem xs="2">
                            <MudButton Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.Send"
                                   Color="Color.Info"
                                   @onclick=@(async()=>
                                   {
                                   await tableDS4Interlock.ReloadServerData();
                                   await InvokeAsync(StateHasChanged);
                                   })>
                                GET INTERLOCK

                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    <MudTable @ref="tableDS4Interlock"
                          Elevation="0"
                          ServerData="@(new Func<TableState, Task<TableData<InterlockDS4Model>>>(ServerReloadDS4Interlock))">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">DS4 Interlock</MudText>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="id_field" T="InterlockDS4Model">No.</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="status_field" T="InterlockDS4Model">STATUS</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="time_field" T="InterlockDS4Model">TIME</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="input_field" T="InterlockDS4Model">INPUT</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="target_field" T="InterlockDS4Model">TARGET UNIT</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;"><MudTableSortLabel SortLabel="control_field" T="InterlockDS4Model">CONTROL</MudTableSortLabel></MudTh>

                            <MudTh Style="text-align:center;">ACTION</MudTh>

                        </HeaderContent>

                        <RowTemplate>
                            <MudTd Style="text-align:center;" DataLabel="No.">
                                <MudBadge Dot="true"
                                      Color="context.data.interlock.stt == 2 ? Color.Error : Color.Success"
                                      Class="mx-6 my-4">
                                    <MudText>@context.data.interlock.id</MudText>
                                </MudBadge>
                            </MudTd>

                            <MudTd Style="text-align:center;" DataLabel="STATUS">
                                @{
                                    var result = "";
                                    if (context.data.interlock.stt != 1)
                                        result = "Disable";
                                    else
                                        result = "Enable";
                                @result
                                    ;
                            }
                        </MudTd>

                        <MudTd Style="text-align:center;" DataLabel="TIME">@context.data.interlock.start.ElementAtOrDefault(0):@context.data.interlock.start.ElementAtOrDefault(1) - @context.data.interlock.stop.ElementAtOrDefault(0):@context.data.interlock.stop.ElementAtOrDefault(1)</MudTd>

                        <MudTd Style="text-align:center;" DataLabel="INPUT">
                            @{
                                    string result = "";
                            }
                            @for (var idx = 0; idx < context.data.input.id.Count; idx++)
                                {
                                    if (context.data.input.id.ElementAtOrDefault(idx) != 0)
                                    {
                                        result += context.data.input.id.ElementAtOrDefault(idx).ToString() + "-" + (context.data.input.opt.ElementAtOrDefault(idx) == 1 ? "On" : "Off") + ", ";
                                    }
                                }
                            @result
                        </MudTd>

                        <MudTd Style="text-align:center;" DataLabel="TARGET">
                            @{
                                    var result = "";
                                    for (var idx = 0; idx < context.data.unit.Count; idx++)
                                    {
                                        if (context.data.unit.ElementAtOrDefault(idx) == 1)
                                            result += idx.ToString() + ", ";
                                    }
                                    if (result.EndsWith(", ")) result = result.Remove(result.Length - 2);
                                @result
                            }
                        </MudTd>

                        <MudTd>
                            @{
                                // Status
                                <MudChip Color="Color.Info">
                                    Status:
                                    @(context.data.control.status == 0 ? "No Change" : context.data.control.status == 1 ? "On" : "Off")
                                </MudChip>

                                // Mode
                                <MudChip Color="Color.Info">
                                    Mode:
                                    @{
                                            var result = "";
                                            switch (context.data.control.mode)
                                            {
                                                case 0:
                                                    result = "No Change";
                                                    break;
                                                case 1:
                                                    result = "Cool";
                                                    break;
                                                case 2:
                                                    result = "Dry";
                                                    break;
                                                case 3:
                                                    result = "Fan";
                                                    break;
                                                case 4:
                                                    result = "Heat";
                                                    break;
                                            }
                                        @result
                                    }
                                </MudChip>

                                // Fan
                                <MudChip Color="Color.Info">
                                    Fan:
                                    @{
                                            var result = "";
                                            switch (context.data.control.fan)
                                            {
                                                case 0:
                                                    result = "No Change";
                                                    break;
                                                case 1:
                                                    result = "Low";
                                                    break;
                                                case 2:
                                                    result = "Mid";
                                                    break;
                                                case 3:
                                                    result = "High";
                                                    break;
                                                case 4:
                                                    result = "Auto";
                                                    break;
                                            }
                                        @result
                                    }
                                </MudChip>

                                // Setpoint
                                <MudChip Color="Color.Info">
                                    Setpoint: @context.data.control.setpoint
                                </MudChip>

                                // Lock
                                <MudChip Color="Color.Info">
                                    Lock: @(context.data.control.@lock == 0 ? "Off" :"On")
                                </MudChip>

                                // Delay
                                <MudChip Color="Color.Info">
                                    Delay: @(context.data.control.delay) minutes
                                </MudChip>
                            }
                        </MudTd>

                        <MudTd>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                <MudMenuItem OnClick="@(() => { PreChangeInterlock(); })">Edit</MudMenuItem>
                            </MudMenu>
                        </MudTd>

                    </RowTemplate>

                </MudTable>
            </MudPaper>

            }


            <!-- Modal New Schedule -->
            <div class="modal animate__animated animate__bounceInUp" data-backdrop="static" data-keyboard="false" id="mdNewScene" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white d-flex justify-content-center flex-column text-center">
                            <h1 class="modal-title w-100">
                                <i class="fas fa-plus-circle"></i>
                            </h1>
                            <h2 class="modal-title w-100">
                                New Interlock Profile
                            </h2>
                        </div>

                        <div class="modal-body">
                            <form @ref="elFormNewScene"
                                  class="needs-validation"
                                  id="formNewWorker"
                                  novalidate>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">Basic Info</legend>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">
                                            <i class="fas fa-info-circle"></i>
                                            Interlock Name
                                        </label>
                                        <div class="col-sm-10">
                                            <input @bind-value="NewSceneParams.Name"
                                                   type="text"
                                                   class="form-control"
                                                   placeholder="-- Name of new Interlock --"
                                                   required />
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">
                                        <h2 class="font-weight-bolder font-italic">IF STATEMENT</h2>
                                    </legend>

                                    <div class="container-fluid">
                                        @foreach (var _express in NewSceneParams.Expressions)
                                        {
                                            int idx = NewSceneParams.Expressions.IndexOf(_express);

                                            <div class="row align-items-center"
                                             id="row-@_express.RandExpId">
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-danger btn-xs"
                                                        type="button"
                                                        @onclick=@(() =>
                                                        {
                                                        NewSceneParams.Expressions.Remove(_express);
                                                        InvokeAsync(StateHasChanged);
                                                        })>
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>

                                                @if (_express.IsLogicExpression == true)
                                                {
                                                    if (_express.Logic == LogicExpression.OpenpArenthesis)
                                                    {
                                                        <div class="col-auto">
                                                            <img src="public/img/bracket_left.png" style="background:green;" />
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.CloseParenthesis)
                                                    {
                                                        <div class="col-auto">
                                                            <img src="public/img/bracket_right.png" style="background:green;" />
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.And)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>AND</h3>
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.Or)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>OR</h3>
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.Not)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>NOT</h3>
                                                        </div>
                                                    }

                                                    <div class="col-3">
                                                        <select title="-- Select Expression --"
                                                        id="slNewCondLogicExpress-@_express.RandExpId"
                                                        data-style="btn-light btn-sm"
                                                        class="form-control selectpicker"
                                                        @bind="NewSceneParams.Expressions.ElementAtOrDefault(idx).Logic">
                                                            @foreach (var obj in Enum.GetValues(typeof(LogicExpression)))
                                                            {
                                                                var value = Enum.GetName(typeof(LogicExpression), obj);
                                                                var key = (int)obj;
                                                                <option value="@key">@value</option>
                                                            }
                                                        </select>
                                                    </div>
                                                }
                                                else if (_express.IsLogicExpression == false)
                                                {
                                                    var _objDevice = LstDevice.Where(r => r.Id == _express.DeviceId).FirstOrDefault();

                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <div class="info-box-content">
                                                                <select title="-- Select AC --"
                                                                id="slNewCondDevice-@idx"
                                                                data-style="btn-light btn-sm"
                                                                class="form-control selectpicker"
                                                                data-live-search="true"
                                                                @bind="NewSceneParams.Expressions.ElementAtOrDefault(idx).DeviceId">
                                                                    @foreach (var _dv in LstDevice)
                                                                    {
                                                                        var resultSubText = "";
                                                                        var secOfDv = LstSection.Where(r => r.Id == _dv.SectionId).FirstOrDefault();
                                                                        if (secOfDv != default)
                                                                        {
                                                                            var zoneOfDv = LstZone.Where(r => r.Id == secOfDv.Zone).FirstOrDefault();
                                                                            if (zoneOfDv != default)
                                                                            {
                                                                                var areaOfDv = LstArea.Where(r => r.Id == zoneOfDv.Area).FirstOrDefault();
                                                                                if (areaOfDv != default)
                                                                                {
                                                                                    resultSubText = areaOfDv.Name + " > " + zoneOfDv.Name + " > " + secOfDv.Name;
                                                                                }
                                                                            }
                                                                        }
                                                                        <option data-subtext="@resultSubText" value="@_dv.Id">[@_dv.Capabilitie] @_dv.Id - @_dv.Name</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-2">
                                                        <div class="info-box">
                                                            <span class="info-box-icon bg-info">
                                                                <i class="@GetCompareSign(NewSceneParams.Expressions.ElementAtOrDefault(idx).Comparison)"></i>
                                                            </span>
                                                            <div class="info-box-content">
                                                                <select title="-- Change --"
                                                                id="slNewCondOperator-@idx"
                                                                data-style="btn-light btn-sm"
                                                                data-live-search="true"
                                                                class="form-control selectpicker"
                                                                @bind="NewSceneParams.Expressions.ElementAtOrDefault(idx).Comparison">
                                                                    @foreach (var obj in Enum.GetValues(typeof(MasterDataModel.CompareOperators)))
                                                                    {
                                                                        var value = Enum.GetName(typeof(MasterDataModel.CompareOperators), obj);
                                                                        var key = (int)obj;
                                                                        <option value="@key">@value</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <div class="info-box-content">
                                                                <select title="-- Select Attribute --"
                                                                id="slNewCondDeviceAttr-@idx"
                                                                data-style="btn-light btn-sm"
                                                                class="form-control selectpicker mb-2"
                                                                data-live-search="true"
                                                                required
                                                                @bind="NewSceneParams.Expressions.ElementAtOrDefault(idx).Attribute">
                                                                    @{
                                                                        var _dictDvAttr = LstDevice.Where(r => r.Id == _express.DeviceId).FirstOrDefault()?.Status;
                                                                        if (_dictDvAttr != default)
                                                                        {
                                                                            foreach (var DvAttr in _dictDvAttr)
                                                                            {
                                                                                <option value="@DvAttr.Key">@DvAttr.Key</option>
                                                                            }
                                                                        }
                                                                    }
                                                                </select>

                                                                @{
                                                                    var _DetailOfAttr = LstAttribute.Where(r => r.Name == NewSceneParams.Expressions.ElementAtOrDefault(idx).Attribute).FirstOrDefault();
                                                                    if (_DetailOfAttr != default)
                                                                    {
                                                                        if (_DetailOfAttr.ValueType == SERVER_TYPES.Enum || _DetailOfAttr.ValueType == SERVER_TYPES.Array)
                                                                        {
                                                                            <select class="form-control"
                                                                    required
                                                                id=@("slNewCondDeviceAttr" + _DetailOfAttr.Name + "-" + _express.RandExpId)
                                                                    @bind="NewSceneParams.Expressions.ElementAtOrDefault(idx).CompareValue">

                                                                                <option value="">-- Select --</option>
                                                                                @foreach (var _valRange in _DetailOfAttr.ValueRange)
                                                                                {
                                                                                    <option value="@_valRange">
                                                                                        @_valRange
                                                                                    </option>
                                                                                }
                                                                            </select>
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.Double)
                                                                        {
                                                                            <input class="form-control"
                                                               type="number"
                                                                   @bind-value="@NewSceneParams.Expressions.ElementAtOrDefault(idx).CompareValue"
                                                                   required
                                                               step="0.01"
                                                               min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                               max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.String)
                                                                        {
                                                                            <input class="form-control"
                                                               type="text"
                                                                   @bind-value="@NewSceneParams.Expressions.ElementAtOrDefault(idx).CompareValue" />
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.Integer)
                                                                        {
                                                                            <input class="form-control"
                                                               type="number"
                                                                   @bind-value="@NewSceneParams.Expressions.ElementAtOrDefault(idx).CompareValue"
                                                               step="1"
                                                                   required
                                                               min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                               max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                        }
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <span class="info-box-icon bg-info">
                                                                <i class="fas fa-stopwatch"></i>
                                                            </span>
                                                            <div class="info-box-content">
                                                                <div class="input-group input-group-sm">
                                                                    <input type="number"
                                                                   class="form-control"
                                                                   min="0"
                                                                   step="1"
                                                                   placeholder="Interval Time"
                                                                   required
                                                                   @bind-value="NewSceneParams.Expressions.ElementAtOrDefault(idx).Interval">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">
                                                                            sec
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                }
                                            </div>
                                        }

                                        <div class="btn-group" role="group">
                                            <button type="button"
                                                    class="btn btn-primary"
                                                    @onclick=@(()=>
                                                    {
                                                    NewSceneParams.Expressions.Add(new ScenesExpressionModel() { IsLogicExpression = true, Logic= LogicExpression.None});
                                                    })>
                                                <i class="fas fa-plus"></i>
                                                Command
                                            </button>
                                            <button type="button"
                                                    class="btn btn-info"
                                                    @onclick=@(()=>
                                                    {
                                                    NewSceneParams.Expressions.Add(new ScenesExpressionModel() { IsLogicExpression = false, Comparison= MasterDataModel.CompareOperators.Equal });
                                                    })>
                                                <i class="fas fa-plus"></i>
                                                Trigger Block
                                            </button>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">
                                        <h2 class="font-weight-bolder font-italic">THEN</h2>
                                    </legend>

                                    <div class="row">
                                        <button class="btn btn-success m-3 btn-block"
                                                type="button"
                                                @onclick=@(() =>
                                                {
                                                NewSceneParams.Actions.Add(new RunningActionModel());
                                                RefilterDvList(NewSceneParams);
                                                })>
                                            <i class="fas fa-plus-circle"></i>
                                            ADD NEW ACTIONS
                                        </button>
                                    </div>

                                    @foreach (var _card in NewSceneParams.Actions)
                                    {
                                        <div class="callout callout-primary">
                                            <div class="mb-4 d-flex">
                                                <h4 class="mr-auto">
                                                    <span class="badge badge-pill badge-primary">NEW</span>
                                                </h4>

                                                <button class="btn btn-outline-danger"
                                                    type="button"
                                                    @onclick=@(() =>
                                                    {
                                                    NewSceneParams.Actions.Remove(_card);
                                                    RefilterDvList(NewSceneParams);
                                                    })>
                                                    <i class="far fa-trash-alt"></i>
                                                </button>
                                            </div>

                                            <div class="row">

                                                @{
                                                    var _dvType = "AC";
                                                    //_dvType = @LstDevice.Where(r => r.Id == _card?.LstDeviceId.FirstOrDefault()).FirstOrDefault()?.DeviceType;
                                                }

                                                <div class="form-group col-5">
                                                    <label>
                                                        Target AC
                                                    </label>
                                                    <div class="input-group ">
                                                        <select class="selectpicker form-control"
                                                            title="-- Select --"
                                                            data-style="btn-primary"
                                                            data-live-search="true"
                                                            multiple
                                                            required
                                                            @onchange=@(async () =>
                                                            {
                                                            SelectAndBindMultiTargetDevice(_card);
                                                            })>
                                                            @foreach (var _dv in LstDevice.Where(r => r.DeviceType == "VRV"))
                                                            {
                                                                var resultSubText = "";
                                                                var secOfDv = LstSection.Where(r => r.Id == _dv.SectionId).FirstOrDefault();
                                                                if (secOfDv != default)
                                                                {
                                                                    var zoneOfDv = LstZone.Where(r => r.Id == secOfDv.Zone).FirstOrDefault();
                                                                    if (zoneOfDv != default)
                                                                    {
                                                                        var areaOfDv = LstArea.Where(r => r.Id == zoneOfDv.Area).FirstOrDefault();
                                                                        if (areaOfDv != default)
                                                                        {
                                                                            resultSubText = areaOfDv.Name + " > " + zoneOfDv.Name + " > " + secOfDv.Name;
                                                                        }
                                                                    }
                                                                }
                                                                <option data-subtext="@resultSubText" value="@_dv.Id">[@_dv.Capabilitie] @_dv.Id - @_dv.Name</option>
                                                            }
                                                        </select>
                                                    </div>


                                                    <label class="m-3">
                                                        Attributes
                                                    </label>
                                                    <div class="input-group">
                                                        <select title="-- Select Attributes --"
                                                            data-style="btn-primary"
                                                            class="form-control selectpicker"
                                                            multiple
                                                            data-live-search="true"
                                                            @onchange=@(async()=>
                                                            {
                                                            await SelectAndBindMultiAttr(_card.SetValues);
                                                            })>
                                                            @{
                                                                if (_dvType != String.Empty && _dvType != "" && _dvType != null)
                                                                {
                                                                    var _lstAttrOfDvType = LstDeviceType.Where(r => r.Name == _dvType).FirstOrDefault().Attributes;
                                                                    foreach (var _attr in _lstAttrOfDvType)
                                                                    {
                                                                        if (LstAttribute.Where(r => r.Name == _attr).FirstOrDefault()?.IsReadOnly == false)
                                                                        {
                                                                            <option value="@_attr">@_attr</option>
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                </div>


                                                <div class="col-7">
                                                    <div class="callout callout-primary">
                                                        <div class="d-flex">
                                                            <div class=" flex-grow-1">
                                                                <ul style="list-style-type: none;">
                                                                    @foreach (var dv in _card.DeviceList)
                                                                    {
                                                                        var objDv = LstDevice.Where(r => r.Id == dv).FirstOrDefault();
                                                                        <li>
                                                                            <span class="badge badge-pill badge-primary">
                                                                                @objDv.Id
                                                                            </span>
                                                                            - [@objDv.Capabilitie] @objDv.Name
                                                                        </li>
                                                                    }
                                                                </ul>
                                                            </div>
                                                        </div>

                                                        <div class="col-12">
                                                            <hr class="dotted">
                                                        </div>

                                                        <div class="row">
                                                            @{
                                                                foreach (var _attr in _card?.SetValues)
                                                                {
                                                                    var _DetailOfAttr = LstAttribute.Where(r => r.Name == _attr.Key).FirstOrDefault();
                                                                    <div class="form-group col-4">
                                                                        <label>
                                                                            @_attr.Key
                                                                        </label>
                                                                        <div class="input-group ">
                                                                            @if (_DetailOfAttr.ValueType == SERVER_TYPES.Enum || _DetailOfAttr.ValueType == SERVER_TYPES.Array)
                                                                            {
                                                                                <select title="-- Select --"
                                                                        class="form-control selectpicker"
                                                                        data-style="btn-light"
                                                                            required
                                                                            @onchange=@(async () =>
                                                                        {
                                                                        var _tmpKeys = await SelectAndBindSingleTextReturn();
                                                                        _card.SetValues[_attr.Key] = _tmpKeys;
                                                                        })>

                                                                                    @foreach (var _valRange in _DetailOfAttr.ValueRange)
                                                                                    {
                                                                                        <option value="@_valRange">
                                                                                            @_valRange
                                                                                        </option>
                                                                                    }
                                                                                </select>
                                                                            }
                                                                            else if (_DetailOfAttr.ValueType == SERVER_TYPES.Double)
                                                                            {
                                                                                <input class="form-control"
                                                                       type="number"
                                                                           @bind-value="@_card.SetValues[_attr.Key]"
                                                                           required
                                                                       step="0.01"
                                                                       min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                                       max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                            }
                                                                            else if (_DetailOfAttr.ValueType == SERVER_TYPES.String)
                                                                            {
                                                                                <input class="form-control"
                                                                       type="text"
                                                                           required
                                                                           @bind-value="@_card.SetValues[_attr.Key]" />
                                                                            }
                                                                            else if (_DetailOfAttr.ValueType == SERVER_TYPES.Integer)
                                                                            {
                                                                                <input class="form-control"
                                                                       type="number"
                                                                           @bind-value="@_card.SetValues[_attr.Key]"
                                                                       step="1"
                                                                           required
                                                                       min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                                       max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                }
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </fieldset>

                                @if (CurrentUser.Roles.Contains(Role.System))
                                {
                                    <fieldset class="border p-2">
                                        <legend class="w-auto">
                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox"
                                                       id="swNewJsAction"
                                                       @bind-value="NewSceneParams.IsJavaScriptType"
                                                       class="custom-control-input">
                                                    <label class="custom-control-label"
                                                       for="swNewJsAction">
                                                        Custom JavaScript Actions
                                                    </label>
                                                </div>
                                            </div>
                                        </legend>

                                        @if (NewSceneParams.IsJavaScriptType)
                                        {
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label">
                                                    <i class="fas fa-user-edit"></i>
                                                    Custom JavaScript
                                                </label>
                                                <div class="col-sm-10">
                                                    <textarea class="summernote"
                                                      required=@(NewSceneParams.IsJavaScriptType ? true : false)
                                                      id="tbNewJsAction"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label"></label>
                                                <div class="col-sm-10">
                                                    <div class="d-flex justify-content-center">
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button type="button" class="btn btn-primary">
                                                                Run
                                                            </button>

                                                            <button type="button" class="btn btn-danger">
                                                                Stop
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Reload Data
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Save
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Close
                                                            </button>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label"></label>
                                                <div class="col-sm-10">
                                                    <textarea class="summernote"
                                                      id="tbNewJsDebug"></textarea>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning" role="alert">
                                                Javascript Action is not in used
                                            </div>
                                        }
                                    </fieldset>
                                }
                            </form>
                        </div>

                        <div class="modal-footer d-flex justify-content-center">
                            <button type="button" class="btn btn-lg btn-outline-info"
                                    data-dismiss="modal">
                                Cancle
                            </button>
                            <button type="button"
                                    class="btn btn-info btn-lg"
                                    @onclick=@(() => { FormNewSubmitScene(); })>
                                Create
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Edit Schedule -->
            <div class="modal animate__animated animate__bounceInUp" data-backdrop="static" data-keyboard="false" id="mdEditScene" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white d-flex justify-content-center flex-column text-center">
                            <h1 class="modal-title w-100">
                                <i class="fas fa-cogs"></i>
                            </h1>
                            <h2 class="modal-title w-100">
                                Edit Interlock
                            </h2>
                        </div>

                        <div class="modal-body">
                            <form @ref="elFormEditScene"
                                  class="needs-validation"
                                  id="formEditWorker"
                                  novalidate>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">Basic Info</legend>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">
                                            <i class="fas fa-info-circle"></i>
                                            Interlock Name
                                        </label>
                                        <div class="col-sm-10">
                                            <input @bind-value="crEditScene.Name"
                                                   type="text"
                                                   class="form-control"
                                                   required />
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">
                                        <h2 class="font-weight-bolder font-italic">IF STATEMENT</h2>
                                    </legend>

                                    <div class="container-fluid">

                                        @foreach (var _express in crEditScene.Expressions)
                                        {
                                            int idx = crEditScene.Expressions.IndexOf(_express);

                                            <div class="row align-items-center">
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-danger btn-xs"
                                                        type="button"
                                                        @onclick=@(() => { crEditScene.Expressions.Remove(_express); })>
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>

                                                @if (_express.IsLogicExpression == true)
                                                {
                                                    if (_express.Logic == LogicExpression.OpenpArenthesis)
                                                    {
                                                        <div class="col-auto">
                                                            <img src="public/img/bracket_left.png" style="background:green;" />
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.CloseParenthesis)
                                                    {
                                                        <div class="col-auto">
                                                            <img src="public/img/bracket_right.png" style="background:green;" />
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.And)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>AND</h3>
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.Or)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>OR</h3>
                                                        </div>
                                                    }
                                                    else if (_express.Logic == LogicExpression.Not)
                                                    {
                                                        <div class="col-auto">
                                                            <h3>NOT</h3>
                                                        </div>
                                                    }

                                                    <div class="col-3">
                                                        <select title="-- Change --"
                                                        id="slEditCondLogicExpress-@idx"
                                                        data-style="btn-light btn-sm"
                                                        class="form-control selectpicker"
                                                        @bind="crEditScene.Expressions.ElementAtOrDefault(idx).Logic">
                                                            @foreach (var obj in Enum.GetValues(typeof(LogicExpression)))
                                                            {
                                                                var value = Enum.GetName(typeof(LogicExpression), obj);
                                                                var key = (int)obj;
                                                                <option value="@key">@value</option>
                                                            }
                                                        </select>
                                                    </div>
                                                }
                                                else if (_express.IsLogicExpression == false)
                                                {
                                                    var _objDevice = LstDevice.Where(r => r.Id == _express.DeviceId).FirstOrDefault();

                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <div class="info-box-content">
                                                                <select title="-- Change AC --"
                                                                id="slEditCondDevice-@idx"
                                                                data-style="btn-light btn-sm"
                                                                class="form-control selectpicker"
                                                                data-live-search="true"
                                                                @bind="crEditScene.Expressions.ElementAtOrDefault(idx).DeviceId">
                                                                    @foreach (var _dv in LstDevice)
                                                                    {
                                                                        var resultSubText = "";
                                                                        var secOfDv = LstSection.Where(r => r.Id == _dv.SectionId).FirstOrDefault();
                                                                        if (secOfDv != default)
                                                                        {
                                                                            var zoneOfDv = LstZone.Where(r => r.Id == secOfDv.Zone).FirstOrDefault();
                                                                            if (zoneOfDv != default)
                                                                            {
                                                                                var areaOfDv = LstArea.Where(r => r.Id == zoneOfDv.Area).FirstOrDefault();
                                                                                if (areaOfDv != default)
                                                                                {
                                                                                    resultSubText = areaOfDv.Name + " > " + zoneOfDv.Name + " > " + secOfDv.Name;
                                                                                }
                                                                            }
                                                                        }
                                                                        <option data-subtext="@resultSubText" value="@_dv.Id">@_dv.Id - @_dv.Name</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col-2">
                                                        <div class="info-box">
                                                            <span class="info-box-icon bg-success">
                                                                <i class="@GetCompareSign(crEditScene.Expressions.ElementAtOrDefault(idx).Comparison)"></i>
                                                            </span>
                                                            <div class="info-box-content">
                                                                <select title="-- Change --"
                                                                id="slEditCondOperator-@idx"
                                                                data-style="btn-light btn-sm"
                                                                class="form-control selectpicker"
                                                                @bind="crEditScene.Expressions.ElementAtOrDefault(idx).Comparison">
                                                                    @foreach (var obj in Enum.GetValues(typeof(MasterDataModel.CompareOperators)))
                                                                    {
                                                                        var value = Enum.GetName(typeof(MasterDataModel.CompareOperators), obj);
                                                                        var key = (int)obj;
                                                                        <option value="@key">@value</option>
                                                                    }
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>


                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <div class="info-box-content">
                                                                <select title="-- Change Attribute --"
                                                                id="slEditCondDeviceAttr-@idx"
                                                                data-style="btn-light btn-sm"
                                                                class="form-control selectpicker mb-2"
                                                                data-live-search="true"
                                                                @bind="crEditScene.Expressions.ElementAtOrDefault(idx).Attribute">
                                                                    @{
                                                                        var _dictDvAttr = LstDevice.Where(r => r.Id == _express.DeviceId).FirstOrDefault()?.Status;
                                                                        if (_dictDvAttr != default)
                                                                        {
                                                                            foreach (var DvAttr in _dictDvAttr)
                                                                            {
                                                                                <option value="@DvAttr.Key">@DvAttr.Key</option>
                                                                            }
                                                                        }
                                                                    }
                                                                </select>

                                                                @{
                                                                    var _DetailOfAttr = LstAttribute.Where(r => r.Name == crEditScene.Expressions.ElementAtOrDefault(idx).Attribute).FirstOrDefault();
                                                                    if (_DetailOfAttr != default)
                                                                    {
                                                                        if (_DetailOfAttr.ValueType == SERVER_TYPES.Enum || _DetailOfAttr.ValueType == SERVER_TYPES.Array)
                                                                        {
                                                                            <select class="form-control"
                                                                    @bind="crEditScene.Expressions.ElementAtOrDefault(idx).CompareValue">

                                                                                @foreach (var _valRange in _DetailOfAttr.ValueRange)
                                                                                {
                                                                                    <option value="@_valRange">
                                                                                        @_valRange
                                                                                    </option>
                                                                                }
                                                                            </select>
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.Double)
                                                                        {
                                                                            <input class="form-control"
                                                               type="number"
                                                                   @bind-value="@crEditScene.Expressions.ElementAtOrDefault(idx).CompareValue"
                                                                   required
                                                               step="0.01"
                                                               min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                               max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.String)
                                                                        {
                                                                            <input class="form-control"
                                                               type="text"
                                                                   required
                                                                   @bind-value="@crEditScene.Expressions.ElementAtOrDefault(idx).CompareValue" />
                                                                        }
                                                                        else if (_DetailOfAttr.ValueType == SERVER_TYPES.Integer)
                                                                        {
                                                                            <input class="form-control"
                                                               type="number"
                                                                   @bind-value="@crEditScene.Expressions.ElementAtOrDefault(idx).CompareValue"
                                                               step="1"
                                                                   required
                                                               min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                               max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                        }
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>


                                                    <div class="col-3">
                                                        <div class="info-box">
                                                            <span class="info-box-icon bg-success">
                                                                <i class="fas fa-stopwatch"></i>
                                                            </span>
                                                            <div class="info-box-content">
                                                                <div class="input-group input-group-sm">
                                                                    <input type="number"
                                                                   class="form-control"
                                                                   min="0"
                                                                   step="1"
                                                                   placeholder="Interval Time"
                                                                   required
                                                                   @bind-value="crEditScene.Expressions.ElementAtOrDefault(idx).Interval">
                                                                    <div class="input-group-append">
                                                                        <span class="input-group-text">
                                                                            sec
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }

                                        <div class="btn-group" role="group">
                                            <button type="button"
                                                    class="btn btn-primary"
                                                    @onclick=@(()=>
                                                    {
                                                    crEditScene.Expressions.Add(new ScenesExpressionModel() { IsLogicExpression = true, Logic= LogicExpression.None});
                                                    })>
                                                <i class="fas fa-plus"></i>
                                                Command
                                            </button>
                                            <button type="button"
                                                    class="btn btn-info"
                                                    @onclick=@(()=>
                                                    {
                                                    crEditScene.Expressions.Add(new ScenesExpressionModel() { IsLogicExpression = false, Comparison= MasterDataModel.CompareOperators.Equal });
                                                    })>
                                                <i class="fas fa-plus"></i>
                                                Trigger Block
                                            </button>
                                        </div>
                                    </div>
                                </fieldset>

                                <fieldset class="border p-2">
                                    <legend class="w-auto">
                                        <h2 class="font-weight-bolder font-italic">THEN</h2>
                                    </legend>

                                    <div class="row">
                                        <button class="btn btn-success m-3 btn-block"
                                                type="button"
                                                @onclick=@(() =>
                                                {
                                                crEditScene.Actions.Add(new RunningActionModel());
                                                RefilterDvList(crEditScene);
                                                //Console.WriteLine(JsonConvert.SerializeObject(crEditScene.Actions));
                                                })>
                                            <i class="fas fa-plus-circle"></i>
                                            ADD ACTIONS
                                        </button>
                                    </div>

                                    @{
                                        // new idea : combine 2 type action list and edit direct in crEditScene >> re fetch list scene item when close modal
                                        // This is List Action fetch from server
                                        // This is List Action create by user and ready to update to DB
                                        foreach (var _card in crEditScene.Actions)
                                        {
                                            <div class="callout callout-warning"
                                             id="cardEdit-@_card.DeviceList.ElementAtOrDefault(0)">
                                                <div class="mb-4 d-flex">
                                                    <h4 class="mr-auto">
                                                        <span class="badge badge-pill badge-primary">EDIT</span> action
                                                    </h4>

                                                    <button class="btn btn-outline-danger"
                                                    type="button"
                                                        @onclick=@(() =>
                                                    {
                                                    crEditScene.Actions.Remove(_card);
                                                    RefilterDvList(crEditScene);
                                                    })>
                                                        <i class="far fa-trash-alt"></i>
                                                    </button>
                                                </div>

                                                <div class="row">
                                                    @{
                                                        var _dvType = "AC";
                                                        //_dvType = @LstDevice.Where(r => r.Id == _card?.LstDeviceId.FirstOrDefault()).FirstOrDefault()?.DeviceType;
                                                    }

                                                    <div class="form-group col-5">
                                                        <label>
                                                            Target AC
                                                        </label>
                                                        <div class="input-group ">
                                                            <select class="selectpicker form-control"
                                                            title="-- Change --"
                                                            id="slEditTriggerDv-@_card.ActionId"
                                                            data-style="btn-primary"
                                                            data-live-search="true"
                                                                multiple
                                                                @onchange=@(async () =>
                                                            {
                                                            SelectAndBindMultiTargetDevice(_card);
                                                            //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
                                                            })>
                                                                @foreach (var _dv in LstDevice.Where(r => r.DeviceType == "VRV"))
                                                                {
                                                                    var resultSubText = "";
                                                                    var secOfDv = LstSection.Where(r => r.Id == _dv.SectionId).FirstOrDefault();
                                                                    if (secOfDv != default)
                                                                    {
                                                                        var zoneOfDv = LstZone.Where(r => r.Id == secOfDv.Zone).FirstOrDefault();
                                                                        if (zoneOfDv != default)
                                                                        {
                                                                            var areaOfDv = LstArea.Where(r => r.Id == zoneOfDv.Area).FirstOrDefault();
                                                                            if (areaOfDv != default)
                                                                            {
                                                                                resultSubText = areaOfDv.Name + " > " + zoneOfDv.Name + " > " + secOfDv.Name;
                                                                            }
                                                                        }
                                                                    }
                                                                    <option data-subtext="@resultSubText" value="@_dv.Id">[@_dv.Capabilitie] @_dv.Id - @_dv.Name</option>
                                                                }
                                                            </select>
                                                        </div>

                                                        <label>
                                                            Attributes
                                                        </label>
                                                        <div class="input-group">
                                                            <select title="-- Select Attributes --"
                                                            data-style="btn-primary"
                                                            class="form-control selectpicker"
                                                                multiple
                                                            id="slEditAttr-@_card.ActionId"
                                                            data-live-search="true"
                                                                @onchange=@(async()=>
                                                            {
                                                            await SelectAndBindMultiAttr(_card.SetValues);
                                                            //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
                                                            })>
                                                                @{
                                                                    if (_dvType != String.Empty && _dvType != "" && _dvType != null)
                                                                    {
                                                                        var _lstAttrOfDvType = LstDeviceType.Where(r => r.Name == _dvType).FirstOrDefault().Attributes;
                                                                        foreach (var _attr in _lstAttrOfDvType)
                                                                        {
                                                                            if (LstAttribute.Where(r => r.Name == _attr).FirstOrDefault()?.IsReadOnly == false)
                                                                            {
                                                                                <option value="@_attr">@_attr</option>
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <div class="col-7">
                                                        <div class="callout callout-primary">
                                                            <div class="d-flex">
                                                                <div class=" flex-grow-1">
                                                                    <ul>
                                                                        @foreach (var dv in _card.DeviceList)
                                                                        {
                                                                            var objDv = LstDevice.Where(r => r.Id == dv).FirstOrDefault();
                                                                            <li>
                                                                                <span class="badge badge-pill badge-primary">
                                                                                    @objDv.Id
                                                                                </span>
                                                                                - [@objDv.Capabilitie] @objDv.Name
                                                                            </li>
                                                                        }
                                                                    </ul>
                                                                </div>
                                                            </div>

                                                            <div class="col-12">
                                                                <hr class="dotted">
                                                            </div>

                                                            <div class="row">
                                                                @{
                                                                    foreach (var _attr in _card?.SetValues)
                                                                    {
                                                                        var _DetailOfAttr = LstAttribute.Where(r => r.Name == _attr.Key).FirstOrDefault();
                                                                        <div class="form-group col-4">
                                                                            <label>
                                                                                @_attr.Key
                                                                            </label>
                                                                            <div class="input-group ">
                                                                                @if (_DetailOfAttr.ValueType == SERVER_TYPES.Enum || _DetailOfAttr.ValueType == SERVER_TYPES.Array)
                                                                                {
                                                                                    <select title="@_attr.Value"
                                                                        class="form-control selectpicker"
                                                                        data-style="btn-light"
                                                                                @onchange=@(async () =>
                                                                        {
                                                                        var _tmpKeys = await SelectAndBindSingleTextReturn();
                                                                        _card.SetValues[_attr.Key] = _tmpKeys;
                                                                        })>

                                                                                        @foreach (var _valRange in _DetailOfAttr.ValueRange)
                                                                                        {
                                                                                            <option value="@_valRange">
                                                                                                @_valRange
                                                                                            </option>
                                                                                        }
                                                                                    </select>
                                                                                }
                                                                                else if (_DetailOfAttr.ValueType == SERVER_TYPES.Double)
                                                                                {
                                                                                    <input class="form-control"
                                                                       type="number"
                                                                               @bind-value="@_card.SetValues[_attr.Key]"
                                                                               required
                                                                       step="0.01"
                                                                       min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                                       max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                                }
                                                                                else if (_DetailOfAttr.ValueType == SERVER_TYPES.String)
                                                                                {
                                                                                    <input class="form-control"
                                                                       type="text"
                                                                               required
                                                                               @bind-value="@_card.SetValues[_attr.Key]" />
                                                                                }
                                                                                else if (_DetailOfAttr.ValueType == SERVER_TYPES.Integer)
                                                                                {
                                                                                    <input class="form-control"
                                                                       type="number"
                                                                               @bind-value="@_card.SetValues[_attr.Key]"
                                                                       step="1"
                                                                               required
                                                                       min="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(0)"
                                                                       max="@_DetailOfAttr.ValueRange.FirstOrDefault().Split(":").ToList().ElementAt(1)" />
                                                                                }
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                </fieldset>

                                @if (CurrentUser.Roles.Contains(Role.System))
                                {
                                    <fieldset class="border p-2">
                                        <legend class="w-auto">

                                            <div class="form-group">
                                                <div class="custom-control custom-switch">
                                                    <input type="checkbox"
                                                       id="swEditJsAction"
                                                       @bind-value="crEditScene.IsJavaScriptType"
                                                       checked="@(crEditScene.IsJavaScriptType?true:false)"
                                                       class="custom-control-input">
                                                    <label class="custom-control-label"
                                                       for="swEditJsAction">
                                                        Custom JavaScript Actions
                                                    </label>
                                                </div>
                                            </div>
                                        </legend>

                                        @if (crEditScene.IsJavaScriptType)
                                        {
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label">
                                                    <i class="fas fa-user-edit"></i>
                                                    Custom JavaScript
                                                </label>
                                                <div class="col-sm-10">
                                                    <textarea class="summernote"
                                                      required=@(crEditScene.IsJavaScriptType ? true : false)
                                                      id="tbEditJsAction"></textarea>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label"></label>
                                                <div class="col-sm-10">
                                                    <div class="d-flex justify-content-center">
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button type="button" class="btn btn-primary">
                                                                Run
                                                            </button>

                                                            <button type="button" class="btn btn-danger">
                                                                Stop
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Reload Data
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Save
                                                            </button>

                                                            <button type="button" class="btn btn-primary">
                                                                Close
                                                            </button>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-2 col-form-label"></label>
                                                <div class="col-sm-10">
                                                    <textarea class="summernote"
                                                      required=@(crEditScene.IsJavaScriptType ? true : false)
                                                      id="tbEditJsDebug">
                                                        </textarea>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning" role="alert">
                                                Javascript Action is not in used
                                            </div>
                                        }
                                    </fieldset>
                                }


                            </form>
                        </div>

                        <div class="modal-footer d-flex justify-content-center">
                            <button type="button" class="btn btn-outline-secondary"
                                    data-dismiss="modal"
                                    @onclick=@(() => { FormEditClose(); })>
                                CLOSE
                            </button>
                            <button type="button"
                                    class="btn btn-danger"
                                    @onclick=@(() => { DeleteItemHandle(crEditScene); })>
                                DELETE SCENE
                            </button>
                            <button type="button"
                                    class="btn btn-primary"
                                    @onclick=@(() => { FormEditSubmitScene(); })>
                                UPDATE SCENE
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @{
                if (flagForceSelectInject)
                {
                    InjectSelectAfterModal(true);
                    //Console.WriteLine("Inline Code");
                }
            }

        </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>

<MudDialog @bind-IsVisible="isModalInterlockVisible"
           Options="new DialogOptions() { NoHeader = true, FullWidth=true, MaxWidth=MaxWidth.Large, DisableBackdropClick=true }">
    <DialogContent>
        <MudContainer Style="max-height: 600px; overflow-y: scroll">


            <MudGrid>
                <MudItem xs="12">
                    <MudTextField T="string"
                                  Label="Id"
                                  Required="true" RequiredError="Id"
                                  Value="crEditDS4Item.data.interlock.id.ToString()"
                                  Disabled="true"
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="int"
                               Label="Status"
                               Required="true" RequiredError="Status"
                               @bind-Value="crEditDS4Item.data.interlock.stt"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">Enable</MudSelectItem>
                        <MudSelectItem Value="2">Disable</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudDivider DividerType="DividerType.Middle" Class="ma-6" />

            <MudGrid>
                <MudItem xs="6">
                    <MudNumericField T="int"
                                     Label="Time start hour"
                                     Required="true" RequiredError="Time start hour"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.interlock.start[0]" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField T="int"
                                     Label="Time start minute"
                                     Required="true" RequiredError="Time start minute"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.interlock.start[1]" />
                </MudItem>

                <MudItem xs="6">
                    <MudNumericField T="int"
                                     Label="Time stop hour"
                                     Required="true" RequiredError="Time stop hour"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.interlock.stop[0]" />
                </MudItem>
                <MudItem xs="6">
                    <MudNumericField T="int"
                                     Label="Time stop minute"
                                     Required="true" RequiredError="Time stop minute"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.interlock.stop[1]" />
                </MudItem>
            </MudGrid>

            <MudDivider DividerType="DividerType.Middle" Class="ma-6" />

            <MudGrid>
                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input id"
                               Required="true" RequiredError="Input id"
                               @bind-Value="crEditDS4Item.data.input.id[0]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No Used</MudSelectItem>
                        @for (int idx = 1; idx <= 31; idx++)
                        {
                            <MudSelectItem Value="idx"></MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input option"
                               Required="true" RequiredError="Input option"
                               @bind-Value="crEditDS4Item.data.input.opt[0]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="0">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>


                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input id"
                               Required="true" RequiredError="Input id"
                               @bind-Value="crEditDS4Item.data.input.id[1]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No Used</MudSelectItem>
                        @for (int idx = 1; idx <= 31; idx++)
                        {
                            <MudSelectItem Value="idx"></MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input option"
                               Required="true" RequiredError="Input option"
                               @bind-Value="crEditDS4Item.data.input.opt[1]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="0">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>



                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input id"
                               Required="true" RequiredError="Input id"
                               @bind-Value="crEditDS4Item.data.input.id[2]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No Used</MudSelectItem>
                        @for (int idx = 1; idx <= 31; idx++)
                        {
                            <MudSelectItem Value="idx"></MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input option"
                               Required="true" RequiredError="Input option"
                               @bind-Value="crEditDS4Item.data.input.opt[2]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="0">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>


                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input id"
                               Required="true" RequiredError="Input id"
                               @bind-Value="crEditDS4Item.data.input.id[3]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No Used</MudSelectItem>
                        @for (int idx = 1; idx <= 31; idx++)
                        {
                            <MudSelectItem Value="idx"></MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="6">
                    <MudSelect T="int"
                               Label="Input option"
                               Required="true" RequiredError="Input option"
                               @bind-Value="crEditDS4Item.data.input.opt[3]"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="0">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>

            <MudDivider DividerType="DividerType.Middle" Class="ma-6" />

            <MudGrid>
                <MudItem xs="2">
                    <MudSelect T="int"
                               Label="Control ac status"
                               Required="true" RequiredError="Control ac status"
                               @bind-Value="crEditDS4Item.data.control.status"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No changed</MudSelectItem>
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="2">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="2">
                    <MudSelect T="int"
                               Label="Control ac mode"
                               Required="true" RequiredError="Control ac mode"
                               @bind-Value="crEditDS4Item.data.control.mode"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No change</MudSelectItem>
                        <MudSelectItem Value="1">Cool</MudSelectItem>
                        <MudSelectItem Value="2">Dry</MudSelectItem>
                        <MudSelectItem Value="3">Fan</MudSelectItem>
                        <MudSelectItem Value="4">Heat</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="2">
                    <MudSelect T="int"
                               Label="Control ac fan"
                               Required="true" RequiredError="Control ac fan"
                               @bind-Value="crEditDS4Item.data.control.fan"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="0">No change</MudSelectItem>
                        <MudSelectItem Value="1">Low</MudSelectItem>
                        <MudSelectItem Value="2">Mid</MudSelectItem>
                        <MudSelectItem Value="3">High</MudSelectItem>
                        <MudSelectItem Value="4">Auto</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="2">
                    <MudNumericField T="int"
                                     Label="Control ac setpoint"
                                     Required="true" RequiredError="Control ac setpoint"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.control.setpoint" />
                </MudItem>

                <MudItem xs="2">
                    <MudNumericField T="int"
                                     Min="0" Max="255"
                                     Label="Interlock delay (min)"
                                     Required="true" RequiredError="Interlock delay (min)"
                                     Variant="Variant.Outlined"
                                     @bind-Value="crEditDS4Item.data.control.delay" />
                </MudItem>

                <MudItem xs="2">
                    <MudSelect T="int"
                               Label="Interlock locked"
                               Required="true" RequiredError="Interlock locked"
                               @bind-Value="@(crEditDS4Item.data.control.@lock)"
                               Variant="Variant.Outlined">
                        <MudSelectItem Value="1">On</MudSelectItem>
                        <MudSelectItem Value="0">Off</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudSelect @ref="MudSelectTargetAC"
                               MultiSelection="true"
                               T="int"
                               Label="Target AC Unit"
                               Required="true" RequiredError="Target AC Unit"
                               MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectionText))"
                               Variant="Variant.Outlined"
                               SelectAll="true"
                               @bind-SelectedValues="_crOptionsTargetDS4AC">
                        <MudSelectItem Value="0">Unit 00</MudSelectItem>
                        <MudSelectItem Value="1">Unit 01</MudSelectItem>
                        <MudSelectItem Value="2">Unit 02</MudSelectItem>
                        <MudSelectItem Value="3">Unit 03</MudSelectItem>
                        <MudSelectItem Value="4">Unit 04</MudSelectItem>
                        <MudSelectItem Value="5">Unit 05</MudSelectItem>
                        <MudSelectItem Value="6">Unit 06</MudSelectItem>
                        <MudSelectItem Value="7">Unit 07</MudSelectItem>
                        <MudSelectItem Value="8">Unit 08</MudSelectItem>
                        <MudSelectItem Value="9">Unit 09</MudSelectItem>
                        <MudSelectItem Value="10">Unit 10</MudSelectItem>
                        <MudSelectItem Value="11">Unit 11</MudSelectItem>
                        <MudSelectItem Value="12">Unit 12</MudSelectItem>
                        <MudSelectItem Value="13">Unit 13</MudSelectItem>
                        <MudSelectItem Value="14">Unit 14</MudSelectItem>
                        <MudSelectItem Value="15">Unit 15</MudSelectItem>
                    </MudSelect>
                </MudItem>

            </MudGrid>
        </MudContainer>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="ClosePreChangeInterlock"
                   Color="Color.Dark">
            Cancel
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Info"
                   OnClick="@(()=>{ SubmitChangeInterlock(); })"
                   Class="px-10">
            Save change
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    bool flagForceSelectInject = false;
    string mudFilterMain = "";

    CloudUser CurrentUser = new CloudUser() { Infor = new UserInfor(), Roles = new List<Role>() };
    List<DeviceModel> crFilterTargetDevice = new List<DeviceModel>();
    GlobalSceneModel crEditScene = new GlobalSceneModel();
    GlobalSceneModel NewSceneParams = new GlobalSceneModel();
    List<GlobalSceneModel> LstScene = new List<GlobalSceneModel>();
    List<GlobalSceneModel> LstAllSceneWithGrSetVal = new List<GlobalSceneModel>();
    List<DeviceModel> LstDevice = new List<DeviceModel>();
    List<AreaModel> LstArea = new List<AreaModel>();
    List<ZoneModel> LstZone = new List<ZoneModel>();
    List<SectionModel> LstSection = new List<SectionModel>();
    List<MasterDataModel.DeviceTypeModel> LstDeviceType = new List<MasterDataModel.DeviceTypeModel>();
    List<MasterDataModel.AttributeModel> LstAttribute = new List<MasterDataModel.AttributeModel>();
    List<DataSourceModel> LstAllDataSource = new List<DataSourceModel>();

    ElementReference elFormEditScene, elFormNewScene;
    enum FormAction { NewTargetDevice, EditPlusTargetDevice }

    ScenesService svScene = new ScenesService();
    UserService svUser = new UserService();
    DeviceDataStore svDevice = new DeviceDataStore();
    LayoutAreaSevice svAreaLayout = new LayoutAreaSevice();
    DataSourceService svDataSource = new DataSourceService();
    MasterDataService svMasterData = new MasterDataService();

    MudSelect<int> MudSelectTargetAC;

    string AccessToken = "";

    protected override async Task OnInitializedAsync()
    {
        AccessToken = await LocalStorage.GetItemAsync<string>("token");
        if (AccessToken == null)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Please Sign In Again", false);
            NavHelper.NavigateTo("/login"); return;
        }
        CurrentUser = await svUser.GetUserAllInforAsync(AccessToken);

        JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "Initializing Data\nPlease Wait ...");

        RefreshListItem();
        await RefetchData(true);

        // In case navigate from query string
        string querySceneId, queryDeviceId;
        if (NavigationHelper.TryGetQueryString<string>(NavHelper, "sceneId", out querySceneId) && querySceneId != null && NavigationHelper.TryGetQueryString<string>(NavHelper, "deviceId", out queryDeviceId) && queryDeviceId != null)
        {
            var _objScene = LstScene.Where(r => r.Id == Convert.ToInt32(querySceneId)).FirstOrDefault();

            await JSHelper.InvokeVoidAsync("Interop_ShowHideModal", "mdEditScene", "show");

            // because cardEdit-* id danh dau theo id cua element dau tien nen phai tim ra listDevice roi lay el dau >> jumptourl
            var _firtDvId = _objScene.Actions.Where(r => r.DeviceList.Contains(Convert.ToInt32(queryDeviceId))).FirstOrDefault()?.DeviceList.ElementAtOrDefault(0);
            await JSHelper.InvokeVoidAsync("Interop_GotoUrlAsync", "cardEdit-" + _firtDvId, 2000);

            InvokeAsync(StateHasChanged); // Error SelectBootstrap not load if not change state here
            PreEdit(_objScene);
        }

        //Timer timer = new Timer();
        //timer.Interval = 5000;
        //timer.Elapsed += async (_, _) =>
        //{
        //    Console.WriteLine("debug 2");
        //    Console.WriteLine(JsonConvert.SerializeObject(await svScene.GetScenesListAsync(AccessToken)));
        //    Console.WriteLine("==========================");
        //};
        //timer.Start();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (flagForceSelectInject)
        {
            InjectSelectAfterModal(false);
        }

        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbEditJsAction", 300, false, false);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbNewJsAction", 300, false, false);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbEditJsDebug", 200, false, false);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbNewJsDebug", 200, false, false);
        JSHelper.InvokeVoidAsync("Interop_PurgeBootstrapSelectCache"); //TODO: Test comment this line
        if (!firstRender)
        {
            return;
        }
        JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelect");
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbEditJsAction", 300, true, false);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbNewJsAction", 300, true, false);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbEditJsDebug", 200, true, true);
        JSHelper.InvokeVoidAsync("Interop_InjectSummerNoteDefault", "tbNewJsDebug", 200, true, true);

        JSHelper.InvokeVoidAsync("Interop_InjectBootstrapTable");
        JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelect");
    }

    private int crDS4InterlockId = 0;
    private string crDS4GwId;
    private MudTable<InterlockDS4Model> tableDS4Interlock;
    private int totalItemsDS4Interlock;
    private List<InterlockDS4Model> pagedDataDS4Interlock;
    InterlockDS4Model crEditDS4Item = new InterlockDS4Model();
    private async Task<TableData<InterlockDS4Model>> ServerReloadDS4Interlock(TableState state)
    {
        var data = new List<InterlockDS4Model>();
        try
        {
            //crEditDS4Item = await svScene.GetDS4InterlockAsync("getInterlock", crDS4InterlockId, Resources.GetLink.DictDS4IP.GetValueOrDefault(crDS4GwId));
            crEditDS4Item = await svScene.GetDS4InterlockAsyncBySrc(crDS4GwId, AccessToken, "getInterlock", crDS4InterlockId);
            data.Add(crEditDS4Item);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            FireNotification("Cannot get this SVMDS4 interlock", Severity.Error);
        }
        totalItemsDS4Interlock = data.Count();
        return new TableData<InterlockDS4Model>() { TotalItems = totalItemsDS4Interlock, Items = data };
        //StateHasChanged();
    }

    private MudTable<GlobalSceneModel> table;
    private int totalItems;
    private List<GlobalSceneModel> pagedData;
    private async Task<TableData<GlobalSceneModel>> ServerReload(TableState state)
    {
        //var data = await svScene.GetScenesListAsync(await LocalStorage.GetItemAsync<string>("token"));

        var data = new List<GlobalSceneModel>();
        data = LstScene.ConvertAll(r => r.DeepCopy());

        data = data.Where(element =>
        {
            if (string.IsNullOrWhiteSpace(mudFilterMain))
                return true;
            if (element.Id.ToString().Contains(mudFilterMain))
                return true;
            if (element.Name.Contains(mudFilterMain))
                return true;
            return false;
        }).ToList();
        totalItems = data.Count();
        switch (state.SortLabel)
        {
            case "id_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Id).ToList();
                break;
            case "name_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Name).ToList();
                break;
            case "enable_field":
                data = data.OrderByDirection(state.SortDirection, o => o.Enable).ToList();
                break;
            case "lastrun_field":
                data = data.OrderByDirection(state.SortDirection, o => o.LastRunTime).ToList();
                break;
        }

        pagedData = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToList();
        return new TableData<GlobalSceneModel>() { TotalItems = totalItems, Items = pagedData };
    }
    private void OnSearch(string text)
    {
        mudFilterMain = text;
        table.ReloadServerData();
    }


    private bool FilterFunc(GlobalSceneModel element)
    {
        if (string.IsNullOrWhiteSpace(mudFilterMain))
            return true;
        if (element.Id.ToString().Contains(mudFilterMain))
            return true;
        if (element.Name.Contains(mudFilterMain))
            return true;
        return false;
    }

    async Task RefilterDvList(GlobalSceneModel _refScene)
    {
        var lstResult = new List<DeviceModel>();
        var lstChosenDv = _refScene.Actions.SelectMany(r => r.DeviceList).ToList();
        crFilterTargetDevice = LstDevice.Where(r => lstChosenDv.Contains(r.Id) == false).ToList();
        InvokeAsync(StateHasChanged);
    }

    async Task RefetchData(bool isNoti)
    {
        if (isNoti) JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "Initializing Data\nPlease Wait ...");

        var taskLstDevice = svDevice.GetOwnerDevicesListAsync(AccessToken);
        var taskLstScene = svScene.GetScenesListAsync(AccessToken);

        var svSchedule = new ScheduleService();
        var taskLstSchedule = svSchedule.GetItemsAsync(AccessToken);

        var taskLstArea = svAreaLayout.GetAreaListAsync(AccessToken);
        var taskLstZone = svAreaLayout.GetZoneListAsync(AccessToken);
        var taskLstSection = svAreaLayout.GetSectionListAsync(AccessToken);
        var taskLstDeviceType = svMasterData.GetDeviceTypeListAsync(AccessToken);
        var taskLstAttribute = svMasterData.GetAttributeListAsync(AccessToken);

        var taskLstAllDataSource = svDataSource.GetDataSourceListAsync(AccessToken);

        await Task.WhenAll(taskLstDevice, taskLstScene, taskLstArea, taskLstZone, taskLstSection, taskLstDeviceType, taskLstAttribute, taskLstSchedule);


        LstDevice = await taskLstDevice;

        LstScene = await taskLstScene;

        var LstSchedule = await taskLstSchedule;

        LstArea = await taskLstArea;

        LstZone = await taskLstZone;

        LstSection = await taskLstSection;

        LstDeviceType = await taskLstDeviceType;

        LstAttribute = await taskLstAttribute;

        LstAllDataSource = await taskLstAllDataSource;

        if (isNoti) JSHelper.InvokeVoidAsync("Interop_Swal2spinner", false, "");

        table.ReloadServerData();


        //debug
        //Console.WriteLine("==========================");
        //Console.WriteLine(JsonConvert.SerializeObject(LstScene));
        //Console.WriteLine("==========================");


        InvokeAsync(StateHasChanged);
    }

    async Task RefreshListItem()
    {
        //LstAllSceneWithGrSetVal.Clear();
        //LstScene = await svScene.GetScenesListAsync(AccessToken);
        //foreach (var _scene in LstScene)
        //{
        //    var objScene = _scene.ShallowCopy();
        //    objScene.createActionsByGrSetVal();
        //    LstAllSceneWithGrSetVal.Add(objScene);
        //}
        //InvokeAsync(StateHasChanged);
    }

    string GetCompareSign(MasterDataModel.CompareOperators _operator)
    {
        switch (_operator)
        {
            case MasterDataModel.CompareOperators.Equal:
                return "fas fa-equals";
            case MasterDataModel.CompareOperators.GreaterThan:
                return "fas fa-greater-than";
            case MasterDataModel.CompareOperators.GreaterThanOrEqual:
                return "fas fa-greater-than-equal";
            case MasterDataModel.CompareOperators.LessThan:
                return "fas fa-less-than";
            case MasterDataModel.CompareOperators.LessThanOrEqual:
                return "fas fa-less-than-equal";
            case MasterDataModel.CompareOperators.NotEqual:
                return "fas fa-not-equal";
            default:
                return "";
        }
    }

    async Task ChangeScheduleStateHandle(GlobalSceneModel _item)
    {
        var _objScene = _item.DeepCopy();
        _objScene.Enable = !_objScene.Enable;
        var result = await svScene.UpdateItemAsync(_objScene, AccessToken);
        if (result)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "success", "Scene " + (_objScene.Enable ? "Enabled" : "Disabled"), true);
            RefreshListItem();
        }
        else
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Oops, Something Went Wrong", true);
        }

        await RefetchData(false);
        table.ReloadServerData();
        InvokeAsync(StateHasChanged);
    }

    async Task DeleteItemHandle(GlobalSceneModel _item)
    {
        var isConfirm = await JSHelper.InvokeAsync<bool>("Interop_Swal2HelperAsync", "warning", "This action cannot be undone", "DELETE THIS SCHEDULE", "#C70039", "Cancel", false);
        if (!isConfirm) return;

        JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "");
        var result = await svScene.DeleteItemAsync(_item.Id, AccessToken);
        if (result)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "success", "Schedule Deleted", true);
            JSHelper.InvokeVoidAsync("Interop_ShowHideModal", "mdEditScene", "hide");

            JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "Initializing Data\nPlease Wait ...");
            RefreshListItem();
            //LstDevice = await svDevice.GetOwnerDevicesListAsync(AccessToken);
            //LstZone = await svAreaLayout.GetZoneListAsync(AccessToken);
            //LstSection = await svAreaLayout.GetSectionListAsync(AccessToken);
            JSHelper.InvokeVoidAsync("Interop_Swal2spinner", false, "");
            RefetchData(false);
        }
        else
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Oops, Something Went Wrong", true);
    }

    //async Task FormNewClose()
    //{
    //    //reset list schedule in case user delete action in modal edit then close modal
    //    RefreshListItem();
    //}

    async Task FormEditClose()
    {
        //reset list sschedule in case user delete action in modal edit then close modal
        RefreshListItem();
    }

    async Task InjectSelectAfterModal(bool nextFlagState)
    {
        // IF STATEMENT field
        foreach (var _express in crEditScene.Expressions)
        {
            int idx = crEditScene.Expressions.IndexOf(_express);
            if (_express.IsLogicExpression == false)
            {
                JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelectionById", "slEditCondDevice-" + idx.ToString(), _express.DeviceId);
                JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelectionById", "slEditCondOperator-" + idx.ToString(), _express.Comparison);
                JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelectionById", "slEditCondDeviceAttr-" + idx.ToString(), _express.Attribute);
            }
        }
        // THEN field
        foreach (var _action in crEditScene.Actions)
        {
            JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelectionById", "slEditTriggerDv-" + _action.ActionId, _action.DeviceList);
            JSHelper.InvokeVoidAsync("Interop_InjectBootstrapSelectionById", "slEditAttr-" + _action.ActionId, _action.SetValues.Keys);
        }

        flagForceSelectInject = nextFlagState;
    }

    string GenSelectElementId(string firstName, string lastName)
    {
        return firstName + lastName;
    }

    async Task PreEdit(GlobalSceneModel _item)
    {
        crEditScene = _item.DeepCopy();

        flagForceSelectInject = true;

        // Parse some value to correct format
        JSHelper.InvokeVoidAsync("Interop_SummerSetCode", "tbEditJsAction", crEditScene.JavaScriptCode, 350);
        // TODO: fix here
        //var txtDebug = svShedule.GetDebugAsync(crEditScene.Id, AccessToken);
        //JSHelper.InvokeVoidAsync("Interop_SummerSetCode", "tbEditJsDebug", txtDebug, 200);



        await JSHelper.InvokeVoidAsync("Interop_PurgeBootstrapSelectCache");
        JSHelper.InvokeVoidAsync("Interop_PurgeValidBtCache");
        await InvokeAsync(StateHasChanged);
        //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
    }

    async Task<string> jQuerySelectAndBindSingleTextReturn()
    {
        var slKeyItem = await JSHelper.InvokeAsync<string>("Interop_jQueryDisplayChange");
        return await Task.FromResult(slKeyItem);
    }

    async Task<string> SelectAndBindSingleTextReturn()
    {
        var _tmpSelectArr = await JSHelper.InvokeAsync<ArrayList>("Interop_DisplayChange");
        var slKeyItem = _tmpSelectArr[0];
        return await Task.FromResult(slKeyItem.ToString());
    }

    async Task<int> SelectAndBindSingle()
    {
        var _tmpSelectArr = await JSHelper.InvokeAsync<ArrayList>("Interop_DisplayChange");
        var slKeyItem = _tmpSelectArr[0];
        return await Task.FromResult(int.Parse(slKeyItem.ToString()));
    }

    private async Task SelectAndBindMultiAttr(Dictionary<string, string> refSetValues)
    {
        var _tmpSelectArr = await JSHelper.InvokeAsync<ArrayList>("Interop_DisplayChange");
        var ParseValue = _tmpSelectArr[0].ToString();
        if (_tmpSelectArr[1] == null) return; // some time random error here so this is fix
        var stateOfValue = bool.Parse(_tmpSelectArr[1].ToString());
        if (stateOfValue)
        {
            if (refSetValues.ContainsKey(ParseValue) == false) refSetValues.Add(ParseValue, null);
        }
        else
        {
            if (refSetValues.ContainsKey(ParseValue) == true) refSetValues.Remove(ParseValue);
        }
        InvokeAsync(StateHasChanged);
    }

    private async void SelectAndBindMultiTargetDevice(RunningActionModel _refAction)
    {
        var _tmpSelectArr = await JSHelper.InvokeAsync<ArrayList>("Interop_DisplayChange");
        var ParseValue = int.Parse(_tmpSelectArr[0].ToString());
        if (_tmpSelectArr[1] == null) return; // some time random error here so this is fix
        var stateOfValue = bool.Parse(_tmpSelectArr[1].ToString());
        // ADD ITEM
        if (stateOfValue)
        {
            if (_refAction.DeviceList.Contains(ParseValue) == false) _refAction.DeviceList.Add(ParseValue);
        }
        // REMOVE ITEM
        else
        {
            if (_refAction.DeviceList.Contains(ParseValue) == true) _refAction.DeviceList.Remove(ParseValue);
        }
        InvokeAsync(StateHasChanged);
    }

    async Task FormNewSubmitScene()
    {
        var isFormValid = await JSHelper.InvokeAsync<bool>("Interop_FormValidate", elFormNewScene);
        if (!isFormValid)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "warning", "Please fill all required field", true);
            return;
        }

        JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "");

        // Convert Some Prop to correct format
        if (NewSceneParams.IsJavaScriptType)
        {
            NewSceneParams.JavaScriptCode = await JSHelper.InvokeAsync<string>("Interop_SummerGetCode", "tbNewJsAction");
        }

        NewSceneParams.GenerateTriggerAttributes();

        var resultDvId = await svScene.InsertItemAsync(NewSceneParams, AccessToken);
        if (resultDvId == false)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Some thing went wrong", false);
            return;
        }
        JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "success", "Device Id <strong>" + resultDvId.ToString() + "</strong> Added", false);
        JSHelper.InvokeVoidAsync("Interop_ShowHideModal", "mdNewScene", "hide");
        RefetchData(false);
    }

    async Task CloneProfileHanlde(GlobalSceneModel _profile)
    {
        var ProfileObj = _profile.DeepCopy();
        var ProfileName = await JSHelper.InvokeAsync<string>("Interop_Swal2InputAsync", "text", "Name your new profile", "Clone");
        if (ProfileName == "") return;

        // Convert Some Prop to correct format
        if (ProfileObj.IsJavaScriptType)
        {
            NewSceneParams.JavaScriptCode = await JSHelper.InvokeAsync<string>("Interop_SummerGetCode", "tbNewJsAction");
        }
        ProfileObj.Name = ProfileName;

        var resultDvId = await svScene.InsertItemAsync(ProfileObj, AccessToken);
        if (resultDvId == false)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Some thing went wrong", false);
            return;
        }
        JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "success", "Scene Cloned", true);

        RefetchData(false);
    }

    async Task FormEditSubmitScene()
    {
        //Console.WriteLine("0");
        //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
        //Console.WriteLine("0 end");

        var isFormValid = await JSHelper.InvokeAsync<bool>("Interop_FormValidate", elFormEditScene);
        if (!isFormValid)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "warning", "Please fill all required field", true);
            //Console.WriteLine("xxx");
            //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
            //Console.WriteLine("xxx end");

            return;
        }
        JSHelper.InvokeVoidAsync("Interop_Swal2spinner", true, "");
        //Console.WriteLine("1");
        //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));
        //Console.WriteLine("1 end");

        // Convert Some Prop to correct format
        if (crEditScene.IsJavaScriptType)
        {
            crEditScene.JavaScriptCode = await JSHelper.InvokeAsync<string>("Interop_SummerGetCode", "tbEditJsAction");
        }
        crEditScene.GenerateTriggerAttributes();
        //Console.WriteLine("2");
        //Console.WriteLine(JsonConvert.SerializeObject(crEditScene));

        var result = await svScene.UpdateItemAsync(crEditScene, AccessToken);
        if (result)
        {
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "success", "Schedule Updated", true);
            JSHelper.InvokeVoidAsync("Interop_ShowHideModal", "mdEditSchedule", "hide");

            //LstSchedule = await svShedule.GetItemsAsync(AccessToken); // this is already called in FormEditClose()
            //LstDevice = await svDevice.GetOwnerDevicesListAsync(AccessToken);
            //LstZone = await svAreaLayout.GetZoneListAsync(AccessToken);
            //LstSection = await svAreaLayout.GetSectionListAsync(AccessToken);
            FormEditClose();
            RefetchData(false);
        }
        else
            JSHelper.InvokeVoidAsync("Interop_Swal2Helper", "error", "Oops, Something Went Wrong", true);

        InvokeAsync(StateHasChanged);
        Console.WriteLine("all end");
    }

    /// <summary>
    /// modal to change ds4 interlock via REST api from front end
    /// </summary>
    ///
    bool isModalInterlockVisible = false;
    DataSourceModel CrDtSrcItem = new DataSourceModel();
    private IEnumerable<int> _crOptionsTargetDS4AC;
    async Task ClosePreChangeInterlock()
    {
        isModalInterlockVisible = false;
        await tableDS4Interlock.ReloadServerData();

        StateHasChanged();

    }
    async Task PreChangeInterlock()
    {
        isModalInterlockVisible = true;

        // covert List _crOptionsTargetDS4AC to Hashset
        var _tmpLstUnit = new List<int>();
        for (var idx = 0; idx < crEditDS4Item.data.unit.Count; idx++)
        {
            if (crEditDS4Item.data.unit[idx] == 1) _tmpLstUnit.Add(idx);
        }
        _crOptionsTargetDS4AC = _tmpLstUnit.AsEnumerable();

        //isModalInterlockVisible = false;
        MudSelectTargetAC.ForceRender(true);
        StateHasChanged();
    }
    async Task SubmitChangeInterlock()
    {
        isModalInterlockVisible = false;
        // covert HashSet _crOptionsTargetDS4AC to List
        crEditDS4Item.data.unit = new List<int>() { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
        foreach (var unitIdx in _crOptionsTargetDS4AC)
        {
            crEditDS4Item.data.unit[unitIdx] = 1;
        }

        //Console.WriteLine(JsonConvert.SerializeObject(crEditDS4Item));

        //var isOk = await svScene.UpdateDS4InterlockAsync(crEditDS4Item, Resources.GetLink.DictDS4IP.GetValueOrDefault(crDS4GwId));
        var isOk = await svScene.UpdateDS4InterlockAsyncBySrc(AccessToken, crDS4GwId, crEditDS4Item);
        if (isOk) FireNotification("Interlock SVMDS4 changed", Severity.Success);
        else FireNotification("Something went wrong!", Severity.Error);
    }

    /// <summary>
    /// Misc. func
    /// </summary>
    /// <param name="message"></param>
    /// <param name="status"></param>
    void FireNotification(string message, MudBlazor.Severity status)
    {
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        Snackbar.Add(message, status);
    }

    private string GetMultiSelectionText(List<string> selectedValues)
    {
        var result = string.Join(", ", selectedValues);
        //if (result.EndsWith(", ")) result = result.Remove(result.Length - 2);
        return result;
    }
}